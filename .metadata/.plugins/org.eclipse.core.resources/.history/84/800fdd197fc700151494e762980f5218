package OpenEJA.Generate;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;

import java.sql.*;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.*;
import java.util.Date;

import OpenEJA.DAL.*;

public class EntityGenerator {

	private List<EntityDetail> entityDetailList;
	private DBAdapter dba;
	private String tableName;
	private String databaseName;

	public EntityGenerator() {
		this.entityDetailList = new LinkedList<EntityDetail>();
		this.dba = DBFactoryAdapter.getDBAdapter();
		this.tableName = "";
		this.databaseName = "";
	}

	public void generateEntity(String tableName, String databaseName) {
		this.tableName = tableName;
		this.databaseName = databaseName;
		ResultSet rs = this.dba.tableDetail(tableName, databaseName);
		this.prepareEntityList(rs);
		String code = this.classGenerationProcess();
		this.createClassFile(code);
	}

	public void generateAllEntities(String databaseName) {
		this.databaseName = databaseName;
		ResultSet tablesResultSet = this.dba.listTables(databaseName);
		try {
			while(tablesResultSet.next()){
				this.tableName = tablesResultSet.getString("table_name");
				this.generateEntity(this.tableName, this.databaseName);
			}
		} catch (SQLException e) {		
			e.printStackTrace();
		}
	}

	private void prepareEntityList(ResultSet rs) {
		try {
			while (rs.next()) {
				EntityDetail entityDetail = new EntityDetail();
				entityDetail.setColumnName(rs.getString("column_name"));
				entityDetail.setColumnDefault(rs.getString("column_default"));
				if (rs.getString("is_nullable").equalsIgnoreCase("YES"))
					entityDetail.setNullable(true);
				else
					entityDetail.setNullable(false);
				entityDetail.setDataType(rs.getString("data_type"));
				entityDetail.setCharMaxLength(rs.getString("character_maximum_length"));
				entityDetail.setColumnKey(rs.getString("column_key"));
				entityDetail.setExtra(rs.getString("extra"));
				this.entityDetailList.add(entityDetail);

			}
			for (EntityDetail ed : entityDetailList) {
				System.out.println(ed.getColumnName() + ":" + ed.getColumnDefault() + ":" + ed.isNullable() + ":"
						+ ed.getDataType() + ":" + ed.getCharMaxLength() + ":" + ed.getColumnKey() + ":"
						+ ed.getExtra());
			}

		} catch (SQLException e) {
			e.printStackTrace();
		}

	}

	private String classGenerationProcess() {

		StringBuilder code = new StringBuilder();
		code.append("package OpenEJA.BO.").append(UpperCamelCase(databaseName) + ";");
		code.append(System.lineSeparator());
		code.append(System.lineSeparator());	
		code.append("import OpenEJA.Annotation.*;");
		code.append(System.lineSeparator());
		code.append("import OpenEJA.ORM.Entity;");
		code.append(System.lineSeparator());
		code.append(System.lineSeparator());
		code.append("@Table(name = '").append(tableName).append("')");
		code.append(System.lineSeparator());
		code.append("public class ").append(UpperCamelCase(tableName)).append(" extends Entity {")
				.append(System.lineSeparator());
		code.append(System.lineSeparator());
		for (EntityDetail ed : entityDetailList) {
			if (ed.getColumnKey().equalsIgnoreCase("PRI"))
				code.append("\t" + "@Id" + System.lineSeparator());
			if (ed.getExtra().equalsIgnoreCase("auto_increment"))
				code.append("\t" + "@AutoGenerated" + System.lineSeparator());
			code.append("\t" + "@Column(name = '").append(ed.getColumnName()).append("'");
			code.append(", type = '").append(ed.getDataType()).append("'");
			if (ed.getCharMaxLength() != null)
				code.append(", length = '").append(ed.getCharMaxLength()).append("'");
			code.append(")").append(System.lineSeparator());

			String columnName = LowerCamelCase(ed.getColumnName());
			if (ed.getDataType().equalsIgnoreCase("int"))
				code.append("\tpublic Integer " + columnName + ";")
						.append(System.lineSeparator() + System.lineSeparator());
			if (ed.getDataType().equalsIgnoreCase("varchar") || ed.getDataType().equalsIgnoreCase("text"))
				code.append("\tpublic String " + columnName + ";")
						.append(System.lineSeparator() + System.lineSeparator());
			if (ed.getDataType().equalsIgnoreCase("datetime") || ed.getDataType().equalsIgnoreCase("date"))
				code.append("\tpublic String " + columnName + ";")
						.append(System.lineSeparator() + System.lineSeparator());
			if (ed.getDataType().equalsIgnoreCase("double") || ed.getDataType().equalsIgnoreCase("float"))
				code.append("\tpublic " + ed.getDataType() + " " + columnName + ";")
						.append(System.lineSeparator() + System.lineSeparator());

		}
		code.append("\tpublic ").append(UpperCamelCase(tableName)).append("(){");
		code.append(System.lineSeparator());
		DateFormat dateFormat = new SimpleDateFormat("yyyy/MM/dd HH:mm:ss");
		Date date = new java.util.Date();
		for (EntityDetail ed : entityDetailList) {
			String columnName = LowerCamelCase(ed.getColumnName());
			if (ed.getDataType().equalsIgnoreCase("int"))
				code.append("\t\tthis.").append(columnName).append(" = 0;").append(System.lineSeparator());
			if (ed.getDataType().equalsIgnoreCase("varchar") || ed.getDataType().equalsIgnoreCase("text"))
				code.append("\t\tthis.").append(columnName).append(" = '';").append(System.lineSeparator());
			if (ed.getDataType().equalsIgnoreCase("datetime") || ed.getDataType().equalsIgnoreCase("date"))
				code.append("\t\tthis.").append(columnName).append(" = '").append(dateFormat.format(date)).append("';")
						.append(System.lineSeparator());
			if (ed.getDataType().equalsIgnoreCase("double") || ed.getDataType().equalsIgnoreCase("float"))
				code.append("\t\tthis.").append(columnName).append(" = 0.0;").append(System.lineSeparator());
		}
		code.append(System.lineSeparator()).append("\t}");
		code.append(System.lineSeparator());

		code.append("}").append(System.lineSeparator());	
		return code.toString().replaceAll("'", "\"");

	}

	private void createClassFile(String code) {
		File dir = new File("../BO/src/OpenEJA/BO/" + UpperCamelCase(this.databaseName));
		if (!dir.exists())
			dir.mkdirs();
		File file = new File("../BO/src/OpenEJA/BO/" + UpperCamelCase(this.databaseName) + "/"
				+ UpperCamelCase(this.tableName) + ".java");
		if (!file.exists()) {
			try {
				file.createNewFile();

			} catch (IOException e) {
				e.printStackTrace();
			}			
		}
		try {
			FileOutputStream fop = new FileOutputStream(file);
			try {
				fop.write(code.getBytes());
				fop.flush();
				fop.close();
			} catch (IOException e) {				
				e.printStackTrace();
			}
		} catch (FileNotFoundException e) {
		
			e.printStackTrace();
		}

	}

	private void resetVariables() {

	}

	public String UpperCamelCase(String s) {
		String[] parts = s.split("_");
		String camelCaseString = "";
		for (String part : parts) {
			camelCaseString = camelCaseString + toProperCase(part);
		}
		return camelCaseString;
	}

	public String LowerCamelCase(String s) {
		String[] parts = s.split("_");
		String camelCaseString = "";
		for (String part : parts) {
			camelCaseString = camelCaseString + toProperCase(part);
		}
		return camelCaseString.substring(0, 1).toLowerCase() + camelCaseString.substring(1);
	}

	public String toProperCase(String s) {
		return s.substring(0, 1).toUpperCase() + s.substring(1).toLowerCase();
	}

}
